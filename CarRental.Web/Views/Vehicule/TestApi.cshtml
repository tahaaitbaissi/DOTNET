@{
    ViewData["Title"] = "Test API Connection";
    var diagnostics = ViewBag.Diagnostics as Dictionary<string, string>;
}

<div class="container mt-5">
    <h1 class="mb-4">üîß Diagnostic API - Test de Connexion</h1>

    <div class="alert alert-info">
        <strong>‚ÑπÔ∏è Information:</strong> Cette page permet de tester la connexion entre le frontend Web et l'API Backend.
    </div>

    @if (diagnostics != null && diagnostics.Any())
    {
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìä R√©sultats du Test</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th style="width: 30%">Test</th>
                            <th>R√©sultat</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in diagnostics)
                        {
                            <tr>
                                <td><strong>@item.Key</strong></td>
                                <td>
                                    @if (item.Value.Contains("200") || item.Value.Contains("OK"))
                                    {
                                        <span class="badge bg-success">‚úì</span>
                                    }
                                    else if (item.Value.Contains("Exception") || item.Value.Contains("Error") || item.Value.Contains("401") || item.Value.Contains("404") || item.Value.Contains("500"))
                                    {
                                        <span class="badge bg-danger">‚úó</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info">‚Ñπ</span>
                                    }
                                    <code>@item.Value</code>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (diagnostics.ContainsKey("Vehicles Count"))
        {
            var count = diagnostics["Vehicles Count"];
            if (count != "0" && count != "null")
            {
                <div class="alert alert-success mt-4">
                    <h5>‚úÖ Succ√®s!</h5>
                    <p>L'API r√©pond correctement et retourne des v√©hicules. Le probl√®me pourrait √™tre dans le rendu de la vue.</p>
                </div>
            }
            else if (count == "0")
            {
                <div class="alert alert-warning mt-4">
                    <h5>‚ö†Ô∏è API Fonctionne mais Aucun V√©hicule</h5>
                    <p>L'API r√©pond correctement mais ne retourne aucun v√©hicule. V√©rifiez:</p>
                    <ul>
                        <li>Que des v√©hicules existent dans la base de donn√©es</li>
                        <li>Que les v√©hicules ont le statut "Available" (0)</li>
                        <li>Que les dates de recherche sont valides</li>
                    </ul>
                </div>
            }
        }

        @if (diagnostics.ContainsKey("Exception"))
        {
            <div class="alert alert-danger mt-4">
                <h5>‚ùå Erreur D√©tect√©e</h5>
                <p><strong>Type:</strong> @diagnostics["Exception Type"]</p>
                <p><strong>Message:</strong> @diagnostics["Exception"]</p>
                @if (diagnostics.ContainsKey("Stack Trace"))
                {
                    <details>
                        <summary>Voir Stack Trace</summary>
                        <pre class="mt-2">@diagnostics["Stack Trace"]</pre>
                    </details>
                }
            </div>
        }
    }
    else
    {
        <div class="alert alert-secondary">
            <p>Aucun diagnostic disponible. Actualisez la page pour lancer le test.</p>
        </div>
    }

    <div class="mt-4">
        <h4>üõ†Ô∏è Actions Sugg√©r√©es</h4>
        <div class="list-group">
            <div class="list-group-item">
                <h6>1. V√©rifiez que l'API est d√©marr√©e</h6>
                <p class="mb-0 text-muted">L'API doit √™tre en cours d'ex√©cution sur <code>http://localhost:5120</code></p>
            </div>
            <div class="list-group-item">
                <h6>2. V√©rifiez appsettings.json</h6>
                <p class="mb-0 text-muted">Assurez-vous que <code>ApiBaseUrl</code> est configur√© correctement</p>
            </div>
            <div class="list-group-item">
                <h6>3. V√©rifiez la base de donn√©es</h6>
                <p class="mb-0 text-muted">Assurez-vous que des v√©hicules existent avec le statut "Available"</p>
            </div>
            <div class="list-group-item">
                <h6>4. V√©rifiez les logs</h6>
                <p class="mb-0 text-muted">Consultez la console pour plus de d√©tails sur les erreurs</p>
            </div>
        </div>
    </div>

    <div class="mt-4 d-flex gap-2">
        <a href="@Url.Action("TestApi", "Vehicule")" class="btn btn-primary">
            üîÑ Actualiser le Test
        </a>
        <a href="@Url.Action("Index", "Vehicule")" class="btn btn-secondary">
            ‚Üê Retour aux V√©hicules
        </a>
        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">
            üè† Accueil
        </a>
    </div>

    <div class="mt-5">
        <h5>üìù Informations de Configuration</h5>
        <div class="card">
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Application</dt>
                    <dd class="col-sm-9">CarRental.Web (Frontend MVC)</dd>

                    <dt class="col-sm-3">API Backend</dt>
                    <dd class="col-sm-9">CarRental.WebApi</dd>

                    <dt class="col-sm-3">URL Attendue</dt>
                    <dd class="col-sm-9"><code>http://localhost:5120</code></dd>

                    <dt class="col-sm-3">Endpoint Test√©</dt>
                    <dd class="col-sm-9"><code>/api/vehicles/available</code></dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<style>
    code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        color: #d63384;
    }

    pre {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        max-height: 300px;
    }

    .list-group-item h6 {
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }
</style>
